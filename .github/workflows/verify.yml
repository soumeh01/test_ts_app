name: Reusable Verify Workflow

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '18'
      package-manager:
        description: 'Package manager to use (npm or yarn)'
        required: false
        type: string
        default: 'npm'
      working-directory:
        description: 'Working directory for verification'
        required: false
        type: string
        default: '.'
      typecheck-script:
        description: 'TypeScript type checking script'
        required: false
        type: string
        default: 'typecheck'
      test-script:
        description: 'Test script to run'
        required: false
        type: string
        default: 'test'
      lint-script:
        description: 'Lint script to run'
        required: false
        type: string
        default: 'lint'
      skip-tests:
        description: 'Skip running tests'
        required: false
        type: boolean
        default: false
      skip-lint:
        description: 'Skip running lint'
        required: false
        type: boolean
        default: false
    outputs:
      typecheck-success:
        description: 'Whether type checking passed'
        value: ${{ jobs.verify.outputs.typecheck-success }}
      test-success:
        description: 'Whether tests passed'
        value: ${{ jobs.verify.outputs.test-success }}
      lint-success:
        description: 'Whether linting passed'
        value: ${{ jobs.verify.outputs.lint-success }}

jobs:
  verify:
    runs-on: ubuntu-latest
    outputs:
      typecheck-success: ${{ steps.typecheck.outcome == 'success' }}
      test-success: ${{ steps.test.outcome == 'success' || steps.test.outcome == 'skipped' }}
      lint-success: ${{ steps.lint.outcome == 'success' || steps.lint.outcome == 'skipped' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: ${{ inputs.package-manager }}

      - name: Install dependencies (npm)
        if: inputs.package-manager == 'npm'
        working-directory: ${{ inputs.working-directory }}
        run: npm ci

      - name: Install dependencies (yarn)
        if: inputs.package-manager == 'yarn'
        working-directory: ${{ inputs.working-directory }}
        run: yarn install --frozen-lockfile

      - name: Run type checking
        id: typecheck
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "Running TypeScript type checking..."
          if [ "${{ inputs.package-manager }}" = "npm" ]; then
            npm run ${{ inputs.typecheck-script }}
          else
            yarn ${{ inputs.typecheck-script }}
          fi

      - name: Run tests
        id: test
        if: inputs.skip-tests == false
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "Running tests..."
          if [ "${{ inputs.package-manager }}" = "npm" ]; then
            if npm run ${{ inputs.test-script }} --if-present; then
              echo "Tests completed successfully"
            else
              echo "No test script found or tests failed"
              exit 1
            fi
          else
            if yarn run ${{ inputs.test-script }} 2>/dev/null; then
              echo "Tests completed successfully"
            else
              echo "No test script found or tests failed"
              exit 1
            fi
          fi

      - name: Skip tests
        id: skip-test
        if: inputs.skip-tests == true
        run: echo "Tests skipped as requested"

      - name: Run linting
        id: lint
        if: inputs.skip-lint == false
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "Running linting..."
          if [ "${{ inputs.package-manager }}" = "npm" ]; then
            if npm run ${{ inputs.lint-script }} --if-present; then
              echo "Linting completed successfully"
            else
              echo "No lint script found, skipping..."
            fi
          else
            if yarn run ${{ inputs.lint-script }} 2>/dev/null; then
              echo "Linting completed successfully"
            else
              echo "No lint script found, skipping..."
            fi
          fi

      - name: Skip linting
        id: skip-lint
        if: inputs.skip-lint == true
        run: echo "Linting skipped as requested"

      - name: Verification summary
        run: |
          echo "## Verification Results 🔍" >> $GITHUB_STEP_SUMMARY
          echo "- **Node Version**: ${{ inputs.node-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Package Manager**: ${{ inputs.package-manager }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Working Directory**: ${{ inputs.working-directory }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results:" >> $GITHUB_STEP_SUMMARY
          echo "- **Type Check**: ${{ steps.typecheck.outcome == 'success' && '✅ Passed' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.skip-tests }}" = "true" ]; then
            echo "- **Tests**: ⏭️ Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Tests**: ${{ steps.test.outcome == 'success' && '✅ Passed' || (steps.test.outcome == '' && '⏭️ No tests found' || '❌ Failed') }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ inputs.skip-lint }}" = "true" ]; then
            echo "- **Linting**: ⏭️ Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Linting**: ${{ steps.lint.outcome == 'success' && '✅ Passed' || (steps.lint.outcome == '' && '⏭️ No lint script found' || '❌ Failed') }}" >> $GITHUB_STEP_SUMMARY
          fi